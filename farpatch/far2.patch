diff -ruN fardev/build.mak fardev-patched/build.mak
--- fardev/build.mak	1970-01-01 02:00:00.000000000 +0200
+++ fardev-patched/build.mak	2009-05-28 00:54:29.421250000 +0300
@@ -0,0 +1,13 @@
+all:
+  cd unicode_far
+  nmake -f makefile_vc MP=/MP
+  cd ..\misc\fexcept
+  nmake -f makefile_vc WIDE=1 MP=/MP
+  cd ..\..\plugins
+  nmake -f makefile_all_vc WIDE=1 MP=/MP
+  cd multiarc
+  nmake -f makefile_vc MP=/MP
+  cd ..\ftp
+  nmake -f makefile_vc MP=/MP
+  cd ..\..
+  unicode_far\tools\m4 -P -I unicode_far installer\installer.mak.m4 > installer.mak
diff -ruN fardev/docs/ClearPluginsCache.bat fardev-patched/docs/ClearPluginsCache.bat
--- fardev/docs/ClearPluginsCache.bat	2007-10-27 17:22:24.199038000 +0300
+++ fardev-patched/docs/ClearPluginsCache.bat	2009-05-28 00:54:29.436875000 +0300
@@ -1,7 +1,4 @@
 @echo off
 rem This batch file cleared the Plugin Cache
 
-echo REGEDIT4 > "%TEMP%\$DelOld$.reg"
-echo [-HKEY_CURRENT_USER\Software\Far\PluginsCache] >> "%TEMP%\$DelOld$.reg"
-start/wait regedit -s "%TEMP%\$DelOld$.reg"
-del "%TEMP%\$DelOld$.reg" > nul
+reg delete HKCU\Software\Far2\PluginsCache /f
diff -ruN fardev/docs/RestoreSettings.bat fardev-patched/docs/RestoreSettings.bat
--- fardev/docs/RestoreSettings.bat	2007-10-27 17:22:24.199038000 +0300
+++ fardev-patched/docs/RestoreSettings.bat	2009-05-28 00:54:29.436875000 +0300
@@ -2,17 +2,13 @@
 rem    This batch file restores Far settings from previously saved
 rem    files FarSave1.reg and FarSave2.reg to the registry
 
-if not exist FarSave?.reg goto import
+if not exist FarSave?.reg goto end
 
-echo REGEDIT4 > "%TEMP%\$DelOld$.reg"
-echo [-HKEY_CURRENT_USER\Software\Far] >> "%TEMP%\$DelOld$.reg"
-echo [-HKEY_LOCAL_MACHINE\Software\Far] >> "%TEMP%\$DelOld$.reg"
+reg delete HKCU\Software\Far2 /f
+reg delete HKLM\Software\Far2 /f
 
-start/wait regedit -s "%TEMP%\$DelOld$.reg"
-del "%TEMP%\$DelOld$.reg" > nul
+reg import FarSave1.reg
+reg import FarSave2.reg
+reg delete HKCU\Software\Far2\PluginsCache /f
 
-:import
-echo REGEDIT4 > "%TEMP%\$DelCache$.reg"
-echo [-HKEY_CURRENT_USER\Software\Far\PluginsCache] >> "%TEMP%\$DelCache$.reg"
-start/wait regedit -s FarSave1.reg FarSave2.reg "%TEMP%\$DelCache$.reg"
-del "%TEMP%\$DelCache$.reg" > nul
+:end
diff -ruN fardev/docs/SaveSettings.bat fardev-patched/docs/SaveSettings.bat
--- fardev/docs/SaveSettings.bat	2007-10-27 17:22:24.199038000 +0300
+++ fardev-patched/docs/SaveSettings.bat	2009-05-28 00:54:29.436875000 +0300
@@ -2,5 +2,5 @@
 rem    This batch file saves Far settings from the registry
 rem    to files FarSave1.reg and FarSave2.reg
 
-regedit /ea FarSave1.reg HKEY_CURRENT_USER\Software\Far
-regedit /ea FarSave2.reg HKEY_LOCAL_MACHINE\Software\Far
+reg export HKCU\Software\Far2 FarSave1.reg
+reg export HKLM\Software\Far2 FarSave2.reg
diff -ruN fardev/plugins/makefile_vc_def_inc fardev-patched/plugins/makefile_vc_def_inc
--- fardev/plugins/makefile_vc_def_inc	2009-01-12 16:40:22.552676000 +0200
+++ fardev-patched/plugins/makefile_vc_def_inc	2009-05-28 00:54:29.436875000 +0300
@@ -127,27 +127,27 @@
 NOWIN98=/OPT:NOWIN98
 !endif
 
+PDBNAME="$(OUTDIR)$(ADDOUTDIR)\$(NAME).pdb"
 !ifndef DEBUG
 CPP_OPT=/DNDEBUG /O1i
 !else
-PDBNAME="$(OUTDIR)$(ADDOUTDIR)\$(NAME).pdb"
-CPP_OPT=/DDEBUG /Od /Fd$(PDBNAME)
+CPP_OPT=/DDEBUG /Od
 !endif
 
 !ifdef AMD64
 COMMONLIB = $(COMMON)\libCRT64.lib
-CPP_PROJ_NO=/nologo /c /W3 /Gy /GF /Zp8 /J $(COMPAT64) /GS- /Gr /GR- /EHs-c- /LD /I"$(COMMON)" /I"$(COMINC)" $(ENV_INC_OPT) $(CPP_WIDE) /D_CRT_SECURE_NO_WARNINGS /D_CRT_NONSTDC_NO_WARNINGS /D_CRT_NON_CONFORMING_SWPRINTFS /D_WIN32_WINNT=0x0502 $(USERCPP)
+CPP_PROJ_NO=/nologo /c /W3 /Gy /GF /Zp8 /J $(COMPAT64) /GS- /Gr /GR- /EHs-c- /LD /I"$(COMMON)" /I"$(COMINC)" $(ENV_INC_OPT) $(CPP_WIDE) /D_CRT_SECURE_NO_WARNINGS /D_CRT_NONSTDC_NO_WARNINGS /D_CRT_NON_CONFORMING_SWPRINTFS /D_WIN32_WINNT=0x0502 $(USERCPP) /Zi /Fd$(PDBNAME)
 ULOUT=-Tpd+
 !elseif defined(IA64)
 COMMONLIB = $(COMMON)\libCRTIA64.lib
-CPP_PROJ_NO=/nologo /c /W3 /Gy /GF /Zp8 /J $(COMPAT64) /GS- /Gr /GR- /EHs-c- /LD /I"$(COMMON)" /I"$(COMINC)" $(ENV_INC_OPT) $(CPP_WIDE) /D_CRT_SECURE_NO_WARNINGS /D_CRT_NONSTDC_NO_WARNINGS /D_CRT_NON_CONFORMING_SWPRINTFS /D_WIN32_WINNT=0x0502 $(USERCPP)
+CPP_PROJ_NO=/nologo /c /W3 /Gy /GF /Zp8 /J $(COMPAT64) /GS- /Gr /GR- /EHs-c- /LD /I"$(COMMON)" /I"$(COMINC)" $(ENV_INC_OPT) $(CPP_WIDE) /D_CRT_SECURE_NO_WARNINGS /D_CRT_NONSTDC_NO_WARNINGS /D_CRT_NON_CONFORMING_SWPRINTFS /D_WIN32_WINNT=0x0502 $(USERCPP) /Zi /Fd$(PDBNAME)
 ULOUT=-Tpd+
 !else
 COMMONLIB = $(COMMON)\libCRT.lib
 !ifdef CPP_UNALIGN
 CPP_ALIGN=/Zp1
 !endif
-CPP_PROJ_NO=/nologo /c /W3 /Gy /GF $(CPP_ALIGN) /J /Gr /GS- /GR- /EHs-c- /LD /I"$(COMMON)" /I"$(COMINC)" $(ENV_INC_OPT) $(CPP_WIDE) /D_CRT_SECURE_NO_WARNINGS /D_CRT_NONSTDC_NO_WARNINGS /D_CRT_NON_CONFORMING_SWPRINTFS /D_WIN32_WINNT=0x0502 $(USERCPP)
+CPP_PROJ_NO=/nologo /c /W3 /Gy /GF $(CPP_ALIGN) /J /Gr /GS- /GR- /EHs-c- /LD /I"$(COMMON)" /I"$(COMINC)" $(ENV_INC_OPT) $(CPP_WIDE) /D_CRT_SECURE_NO_WARNINGS /D_CRT_NONSTDC_NO_WARNINGS /D_CRT_NON_CONFORMING_SWPRINTFS /D_WIN32_WINNT=0x0502 $(USERCPP) /Zi /Fd$(PDBNAME)
 ULOUT=-Tpd -Re
 !endif
 CPP_PROJ=$(CPP_PROJ_NO) /Fo"$(OBJDIR)\\"
@@ -172,15 +172,13 @@
 
 !ifndef ULINK
 LNK=$(_LINK_PATH_)link.exe
-LINK_DEBUG=/pdb:$(PDBNAME)
-CPP_DEBUG=/Zi
 !ifndef NEEDENTRY
 NOENTRY = /noentry
 !endif
 !ifndef NEEDDEFLIB
 NODEFLIB = /nodefaultlib
 !endif
-LINK_FLAGS=/nologo /dll /release /merge:.rdata=.text $(NOWIN98) $(NOENTRY) $(NODEFLIB) $(ENV_LIB_OPT) /def:"$(DEF)" /map:"$(MAP)" /out:"$(DLLFULLNAME)"
+LINK_FLAGS=/nologo /dll /release /merge:.rdata=.text $(NOWIN98) $(NOENTRY) $(NODEFLIB) $(ENV_LIB_OPT) /def:"$(DEF)" /map:"$(MAP)" /out:"$(DLLFULLNAME)" /debug /pdb:$(PDBNAME)
 !else
 LINK_DEBUG=-v
 CPP_DEBUG=/Z7
diff -ruN fardev/plugins/tmppanel/TmpClass.cpp fardev-patched/plugins/tmppanel/TmpClass.cpp
--- fardev/plugins/tmppanel/TmpClass.cpp	2009-04-08 02:40:49.545164000 +0300
+++ fardev-patched/plugins/tmppanel/TmpClass.cpp	2009-05-28 00:54:29.436875000 +0300
@@ -153,6 +153,17 @@
 #undef _NAME
 }
 
+bool IsSlash(TCHAR ch) {
+  return (ch == _T('\\')) || (ch == _T('/'));
+}
+
+bool IsAbsPath(const TCHAR* path) {
+  unsigned len = lstrlen(path);
+  if (len < 2) return false;
+  if ((path[1] == _T(':')) && ((len == 2) || IsSlash(path[2]))) return true;
+  else if (IsSlash(path[0]) && IsSlash(path[1])) return true;
+  else return false;
+}
 
 int TmpPanel::PutOneFile(PluginPanelItem &PanelItem)
 {
@@ -175,16 +186,17 @@
   if(CheckForCorrect(CurName,&CurPanelItem->FindData,Opt.AnyInPanel))
   {
     int NameOnly=(FSF.PointToName(CurName)==CurName);
+    bool IsRelPath=!IsAbsPath(CurName);
 #undef CurName
 
 #ifndef UNICODE
-    lstrcpy(CurPanelItem->FindData.cFileName, NameOnly ? CurDir : "");
+    lstrcpy(CurPanelItem->FindData.cFileName, IsRelPath ? CurDir : "");
     lstrcat(CurPanelItem->FindData.cFileName,PanelItem.FindData.cFileName);
 #else
     size_t wlen = lstrlen(PanelItem.FindData.lpwszFileName);
-    if (NameOnly) wlen += lstrlen(CurDir);
+    if (IsRelPath) wlen += lstrlen(CurDir);
     register wchar_t *wp = (wchar_t*)malloc((wlen+1)*sizeof(wchar_t));
-    lstrcpy(wp, NameOnly ? CurDir : L"");
+    lstrcpy(wp, IsRelPath ? CurDir : L"");
     lstrcat(wp, PanelItem.FindData.lpwszFileName);
     CurPanelItem->FindData.lpwszFileName = wp;
 #endif
@@ -275,6 +287,8 @@
 #ifdef UNICODE
       if(TmpPanelItem[i].FindData.lpwszFileName)
         TmpPanelItem[i].FindData.lpwszFileName = wcsdup(TmpPanelItem[i].FindData.lpwszFileName);
+      if(TmpPanelItem[i].FindData.lpwszAlternateFileName)
+        TmpPanelItem[i].FindData.lpwszAlternateFileName = wcsdup(TmpPanelItem[i].FindData.lpwszAlternateFileName);
 #endif
     }
   }
diff -ruN fardev/plugins/tmppanel/TmpMix.cpp fardev-patched/plugins/tmppanel/TmpMix.cpp
--- fardev/plugins/tmppanel/TmpMix.cpp	2009-02-24 01:24:39.118043000 +0200
+++ fardev-patched/plugins/tmppanel/TmpMix.cpp	2009-05-28 00:54:29.436875000 +0300
@@ -49,10 +49,10 @@
 #ifdef UNICODE
       if (Items[I].FindData.lpwszFileName)
         free ((wchar_t*)Items[I].FindData.lpwszFileName);
-/*
+
       if (Items[I].FindData.lpwszAlternateFileName)
         free ((wchar_t*)Items[I].FindData.lpwszAlternateFileName);
-*/
+
 #endif
     }
     free (Items);
diff -ruN fardev/unicode_far/filelist.cpp fardev-patched/unicode_far/filelist.cpp
--- fardev/unicode_far/filelist.cpp	2009-05-27 18:55:10.296166000 +0300
+++ fardev-patched/unicode_far/filelist.cpp	2009-05-28 00:54:29.452500000 +0300
@@ -891,7 +891,7 @@
             {
               CtrlObject->Plugins.GetOpenPluginInfo(hPlugin,&Info);
             }
-            if (PanelMode!=PLUGIN_PANEL || (Info.Flags & OPIF_REALNAMES))
+            if (PanelMode!=PLUGIN_PANEL)
               CreateFullPathName(CurPtr->strName,CurPtr->strShortName,CurPtr->FileAttr, strFileName, Key==KEY_CTRLALTF);
             else
             {
@@ -3429,7 +3429,7 @@
     if(FillPathName)
     {
 
-      if (PanelMode!=PLUGIN_PANEL || (Info.Flags & OPIF_REALNAMES))
+      if (PanelMode!=PLUGIN_PANEL)
       {
         /* $ 14.02.2002 IS
            ".." в текущем каталоге обработаем как имя текущего каталога
diff -ruN fardev/unicode_far/findfile.cpp fardev-patched/unicode_far/findfile.cpp
--- fardev/unicode_far/findfile.cpp	2009-05-27 21:05:18.219657000 +0300
+++ fardev-patched/unicode_far/findfile.cpp	2009-05-28 01:22:19.093125000 +0300
@@ -560,44 +560,36 @@
 
 void SetPluginDirectory(const wchar_t *DirName,HANDLE hPlugin,bool UpdatePanel=false)
 {
-  /* $ 19.01.2003 KM
-     Восстановлю поведение до 4 беты. Если в DirName есть
-     символ '\x1' значит это путь из плагина. Таким образом
-     легче определить плагиновые пути и, соответственно,
-     сделать правильный переход.
-  */
 	if(DirName && *DirName)
 	{
-		wchar_t PathSeparator=L'\\';
-		string strName = DirName;
-		if(strName.Contains(L'\x1'))
-			PathSeparator=L'\x1';
-		LPWSTR StartName=strName.GetBuffer(),EndName;
-		while((EndName=wcschr(StartName,PathSeparator))!=NULL)
+		string strName(DirName);
+		wchar_t* DirPtr = strName.GetBuffer();
+		wchar_t* NamePtr = (wchar_t*) PointToName(DirPtr);
+		if (NamePtr != DirPtr)
 		{
-			*EndName=0;
-			// RereadPlugin
+			*(NamePtr-1) = 0;
+
+			if (*DirPtr)
+				CtrlObject->Plugins.SetDirectory(hPlugin,DirPtr,0);
+			else
 			{
-				int FileCount=0;
-				PluginPanelItem *PanelData=NULL;
-				if(CtrlObject->Plugins.GetFindData(hPlugin,&PanelData,&FileCount,OPM_FIND))
-				{
-					CtrlObject->Plugins.FreeFindData(hPlugin,PanelData,FileCount);
-				}
+				// change to root directory only if not already there
+				// otherwise plugin may close
+				struct OpenPluginInfo Info;
+				CtrlObject->Cp()->ActivePanel->GetOpenPluginInfo(&Info);
+				if (wcscmp(Info.CurDir, L"\\") != 0)
+					CtrlObject->Plugins.SetDirectory(hPlugin,L"\\",0);
 			}
-			CtrlObject->Plugins.SetDirectory(hPlugin,StartName,OPM_FIND);
-			StartName=EndName+1;
 		}
+
 		// Отрисуем панель при необходимости.
-		if(UpdatePanel)
+		if (UpdatePanel)
 		{
 			CtrlObject->Cp()->ActivePanel->Update(UPDATE_KEEP_SELECTION);
-			if(!CtrlObject->Cp()->ActivePanel->GoToFile(StartName))
-			{
-				CtrlObject->Cp()->ActivePanel->GoToFile(DirName);
-			}
+			CtrlObject->Cp()->ActivePanel->GoToFile(NamePtr);
 			CtrlObject->Cp()->ActivePanel->Show();
 		}
+
 		//strName.ReleaseBuffer(); Не надо. Строка все ровно удаляется, лишний вызов StrLength.
 	}
 }
@@ -930,8 +922,8 @@
   wchar_t *lpFileName = xf_wcsdup (PanelItem->FindData.lpwszFileName);
   wchar_t *lpFileNameShort = xf_wcsdup (PanelItem->FindData.lpwszAlternateFileName);
 
-  const wchar_t *lpFileNameToFind = PointToName(RemovePseudoBackSlash(lpFileName));
-  const wchar_t *lpFileNameToFindShort = PointToName(RemovePseudoBackSlash(lpFileNameShort));
+  const wchar_t *lpFileNameToFind = PointToName(lpFileName);
+  const wchar_t *lpFileNameToFindShort = PointToName(lpFileNameShort);
 
   if ( CtrlObject->Plugins.GetFindData (
       hPlugin,
@@ -946,11 +938,11 @@
       PluginPanelItem Item = *pItem;
 
       wchar_t *lpwszFileName = xf_wcsdup(NullToEmpty(pItem->FindData.lpwszFileName));
-      Item.FindData.lpwszFileName = xf_wcsdup (PointToName(RemovePseudoBackSlash(lpwszFileName)));
+      Item.FindData.lpwszFileName = xf_wcsdup (PointToName(lpwszFileName));
       xf_free (lpwszFileName);
 
       lpwszFileName = xf_wcsdup(NullToEmpty(pItem->FindData.lpwszAlternateFileName));
-      Item.FindData.lpwszAlternateFileName = xf_wcsdup (PointToName(RemovePseudoBackSlash(lpwszFileName)));
+      Item.FindData.lpwszAlternateFileName = xf_wcsdup (PointToName(lpwszFileName));
       xf_free (lpwszFileName);
 
       if ( !StrCmp (lpFileNameToFind, Item.FindData.lpwszFileName) &&
@@ -1315,21 +1307,28 @@
         break;
       string strSearchFileName;
       int RemoveTemp=FALSE;
-      if ((hPlugin != INVALID_HANDLE_VALUE) && (ArcList[FindFileArcIndex]->Flags & OPIF_REALNAMES)==0)
+      if (hPlugin != INVALID_HANDLE_VALUE)
       {
-        string strTempDir;
-        FarMkTempEx(strTempDir); // А проверка на NULL???
-				apiCreateDirectory(strTempDir,NULL);
-        WaitForSingleObject(hPluginMutex,INFINITE);
-        if (!CtrlObject->Plugins.GetFile(hPlugin,FileItem,strTempDir,strSearchFileName,OPM_SILENT|OPM_FIND))
+        if (!CtrlObject->Plugins.UseFarCommand(hPlugin, PLUGIN_FARGETFILES))
         {
-          ReleaseMutex(hPluginMutex);
-          apiRemoveDirectory(strTempDir);
-          break;
+          string strTempDir;
+          FarMkTempEx(strTempDir); // А проверка на NULL???
+          apiCreateDirectory(strTempDir,NULL);
+          WaitForSingleObject(hPluginMutex,INFINITE);
+          if (!CtrlObject->Plugins.GetFile(hPlugin,FileItem,strTempDir,strSearchFileName,OPM_SILENT|OPM_FIND))
+          {
+            ReleaseMutex(hPluginMutex);
+            apiRemoveDirectory(strTempDir);
+            break;
+          }
+          else
+            ReleaseMutex(hPluginMutex);
+          RemoveTemp=TRUE;
+        }
+        else 
+        {
+          strSearchFileName = strPluginSearchPath + FullName;
         }
-        else
-          ReleaseMutex(hPluginMutex);
-        RemoveTemp=TRUE;
       }
       else
       {
@@ -1424,7 +1423,7 @@
       if(Param2 == KEY_LEFT || Param2 == KEY_RIGHT || Param2 == KEY_NUMPAD4 || Param2 == KEY_NUMPAD6)
         FindPositionChanged = TRUE;
 
-      // некторые спец.клавиши всеже отбработаем.
+      // Некоторые спец.клавиши все-же обработаем.
       if(Param2 == KEY_CTRLALTSHIFTPRESS || Param2 == KEY_ALTF9)
       {
         IsProcessAssignMacroKey--;
@@ -2083,8 +2082,7 @@
 					string strFileName=FindList[FindExitIndex]->FindData.strFileName;
 					Panel *FindPanel=CtrlObject->Cp()->ActivePanel;
 
-					if ((FindList[FindExitIndex]->ArcIndex != LIST_INDEX_NONE) &&
-							(!(ArcList[FindList[FindExitIndex]->ArcIndex]->Flags & OPIF_REALNAMES)))
+					if (FindList[FindExitIndex]->ArcIndex != LIST_INDEX_NONE)
 					{
 						HANDLE hPlugin = ArcList[FindList[FindExitIndex]->ArcIndex]->hPlugin;
 						if (hPlugin == INVALID_HANDLE_VALUE)
@@ -2113,7 +2111,7 @@
 									SearchMode==FFSEARCH_ALL ||
 									SearchMode==FFSEARCH_ALL_BUTNETWORK ||
 									SearchMode==FFSEARCH_INPATH)
-								CtrlObject->Plugins.SetDirectory(hPlugin,L"\\",OPM_FIND);
+								CtrlObject->Plugins.SetDirectory(hPlugin,L"\\",0);
 
 							SetPluginDirectory(strFileName,hPlugin,TRUE);
 						}
@@ -2619,8 +2617,6 @@
   string strPathName;
   strPathName = FullName;
 
-  RemovePseudoBackSlash(strPathName);
-
   CutToSlash(strPathName);
 
   if ( strPathName.IsEmpty() )
@@ -2738,7 +2734,8 @@
     struct OpenPluginInfo Info;
     CtrlObject->Plugins.GetOpenPluginInfo(hPlugin,&Info);
     strSaveDir = Info.CurDir;
-		strPluginSearchPath=strSaveDir+L"\x1";
+    strPluginSearchPath=Info.CurDir;
+    if (!strPluginSearchPath.IsEmpty()) AddEndSlash(strPluginSearchPath);
     WaitForSingleObject(hPluginMutex,INFINITE);
     if (SearchMode==FFSEARCH_ROOT ||
         SearchMode==FFSEARCH_ALL ||
@@ -2827,15 +2824,9 @@
       string strFullName;
       if (StrCmp(strCurName,L".")==0 || TestParentFolderName(strCurName))
         continue;
-      if (Flags & OPIF_REALNAMES)
-      {
-        strFullName = strCurName;
-      }
-      else
-      {
-        strFullName = strPluginSearchPath;
-        strFullName += strCurName;
-      }
+
+      strFullName = strPluginSearchPath;
+      strFullName += strCurName;
 
       /* $ 30.09.2003 KM
         Отфильтруем файлы не попадающие в действующий фильтр
@@ -2851,7 +2842,6 @@
           statusCS.Enter();
 
           strFindMessage = strFullName;
-          RemovePseudoBackSlash(strFindMessage);
           FindMessageReady=TRUE;
 
           statusCS.Leave();
@@ -2881,28 +2871,29 @@
         WaitForSingleObject(hPluginMutex,INFINITE);
 
 				size_t pos;
-        if (!strCurName.Contains(L'\x1') && CtrlObject->Plugins.SetDirectory(hPlugin,strCurName,OPM_FIND))
+        if (CtrlObject->Plugins.SetDirectory(hPlugin,strCurName,OPM_FIND))
         {
           ReleaseMutex(hPluginMutex);
 
           strPluginSearchPath += strCurName;
-          strPluginSearchPath += L"\x1";
-          ScanPluginTree(hDlg,hPlugin, Flags);
-          if (strPluginSearchPath.RPos(pos,L'\x1'))
+          strPluginSearchPath += L"\\";
+          ScanPluginTree(hDlg, hPlugin, Flags);
+          if (strPluginSearchPath.RPos(pos,L'\\'))
             strPluginSearchPath.SetLength(pos);
+          if (strPluginSearchPath.RPos(pos,L'\\'))
+            strPluginSearchPath.SetLength(pos+1);
+          else
+            strPluginSearchPath.SetLength(0);
+
+          WaitForSingleObject(hPluginMutex,INFINITE);
+          if (!CtrlObject->Plugins.SetDirectory(hPlugin,L"..",OPM_FIND))
+            StopSearch=TRUE;
+          ReleaseMutex(hPluginMutex);
         }
-        if (strPluginSearchPath.RPos(pos,L'\x1'))
-          strPluginSearchPath.SetLength(pos+1);
         else
-          strPluginSearchPath.SetLength(0);
-        WaitForSingleObject(hPluginMutex,INFINITE);
-        if (!CtrlObject->Plugins.SetDirectory(hPlugin,L"..",OPM_FIND))
-          StopSearch=TRUE;
-        ReleaseMutex(hPluginMutex);
-        if (StopSearch) break;
+          ReleaseMutex(hPluginMutex);
       }
-      else
-        ReleaseMutex(hPluginMutex);
+      if (StopSearch) break;
     }
   }
   CtrlObject->Plugins.FreeFindData(hPlugin,PanelData,ItemCount);
diff -ruN fardev/unicode_far/flupdate.cpp fardev-patched/unicode_far/flupdate.cpp
--- fardev/unicode_far/flupdate.cpp	2009-05-24 16:47:07.418109000 +0300
+++ fardev-patched/unicode_far/flupdate.cpp	2009-05-28 01:29:58.249375000 +0300
@@ -267,6 +267,7 @@
 	bool bDotSeen=false, bTwoDotsSeen=false;
 	bool bCurDirRoot=IsLocalRootPath(strCurDir)?true:false;
 
+	if (!Done)
 	{
 		string strTemp(NTPath(strCurDir).Str);
 		DWORD dw;
@@ -771,10 +772,6 @@
 
     //memset(CurListData,0,sizeof(*CurListData));
     PluginToFileListItem(CurPanelData,CurListData);
-    if(Info.Flags & OPIF_REALNAMES)
-    {
-        ConvertNameToShort (CurListData->strName, CurListData->strShortName);
-    }
     CurListData->Position=I;
 
     if ((Info.Flags & OPIF_USESORTGROUPS)/* && (CurListData->FileAttr & FILE_ATTRIBUTE_DIRECTORY)==0*/)
diff -ruN fardev/unicode_far/makefile_vc fardev-patched/unicode_far/makefile_vc
--- fardev/unicode_far/makefile_vc	2009-05-24 16:47:07.418109000 +0300
+++ fardev-patched/unicode_far/makefile_vc	2009-05-28 00:54:29.468125000 +0300
@@ -289,25 +289,25 @@
 	/D "_CRT_NONSTDC_NO_DEPRECATE"\
 	/D "_CRT_NON_CONFORMING_SWPRINTFS"
 
-CPP_PROJ_COMMON=$(MP) $(COMPAT64) /W3 /nologo $(FARSYSLOG) /EHs-c- $(DEFINES) /Gy /GF /Fo"$(INTDIR)\\" /Fd"$(INTDIR)\\" /J /c /FAcs /Fa"$(CODDIR)\\"
-CPP_PROJ_RELEASE=/MT /O2
-CPP_PROJ_DEBUG=/MTd /Od /Zi
+CPP_PROJ_COMMON=$(MP) $(COMPAT64) /W3 /nologo $(FARSYSLOG) /EHs-c- $(DEFINES) /Gy /GF /Fo"$(INTDIR)\\" /Fd"$(INTDIR)\\" /J /c /FAcs /Fa"$(CODDIR)\\" /Zi
+CPP_PROJ_RELEASE=/MT /O2 /GL
+CPP_PROJ_DEBUG=/MTd /Od
 
-LINK_COMMON=$(LINK32_LIBS) /OPT:REF /OPT:ICF $(NOWIN98) /nologo /subsystem:console /def:"$(DEF_FILE)" /out:"$(OUTDIR)\Far.exe" /map:"$(OUTDIR)\far.map" /pdb:"$(OUTDIR)\far.pdb" /release
+LINK_COMMON=$(LINK32_LIBS) $(NOWIN98) /nologo /subsystem:console /def:"$(DEF_FILE)" /out:"$(OUTDIR)\Far.exe" /map:"$(OUTDIR)\far.map" /pdb:"$(OUTDIR)\far.pdb" /release /debug /fixed:no
 
 !if "$(OUTDIR)" == "Release.32.vc"
 
 USEDEBUG=NDEBUG
 
 CPP_PROJ=$(CPP_PROJ_COMMON) $(CPP_PROJ_RELEASE) $(CPP_ADD_32) /Zp4
-LINK32_FLAGS=$(LINK_COMMON) /incremental:no /machine:i386
+LINK32_FLAGS=$(LINK_COMMON) /incremental:no /machine:i386 /OPT:REF /OPT:ICF /LTCG
 
 !elseif "$(OUTDIR)" == "Release.64.vc"
 
 USEDEBUG=NDEBUG
 
 CPP_PROJ=$(CPP_PROJ_COMMON) $(CPP_PROJ_RELEASE) /GS- /GR- /Zp8
-LINK32_FLAGS=$(LINK_COMMON) /incremental:no /machine:amd64
+LINK32_FLAGS=$(LINK_COMMON) /incremental:no /machine:amd64 /OPT:REF /OPT:ICF /LTCG
 ULINK_FLAGS=-Tpe+
 
 !elseif "$(OUTDIR)" == "Release.IA64.vc"
@@ -315,14 +315,14 @@
 USEDEBUG=NDEBUG
 
 CPP_PROJ=$(CPP_PROJ_COMMON) $(CPP_PROJ_RELEASE) /GS- /GR- /Zp8
-LINK32_FLAGS=$(LINK_COMMON) /incremental:no /machine:IA64
+LINK32_FLAGS=$(LINK_COMMON) /incremental:no /machine:IA64 /OPT:REF /OPT:ICF /LTCG
 
 !elseif "$(OUTDIR)" == "Debug.64.vc"
 
 USEDEBUG=_DEBUG
 
 CPP_PROJ=$(CPP_PROJ_COMMON) $(CPP_PROJ_DEBUG) /GS- /GR-
-LINK32_FLAGS=$(LINK_COMMON) /debug /machine:amd64
+LINK32_FLAGS=$(LINK_COMMON) /machine:amd64
 ULINK_FLAGS=-Tpe+ -v
 
 !elseif "$(OUTDIR)" == "Debug.IA64.vc"
@@ -330,14 +330,14 @@
 USEDEBUG=_DEBUG
 
 CPP_PROJ=$(CPP_PROJ_COMMON) $(CPP_PROJ_DEBUG) /GS- /GR-
-LINK32_FLAGS=$(LINK_COMMON) /debug /machine:IA64
+LINK32_FLAGS=$(LINK_COMMON) /machine:IA64
 
 !else
 
 USEDEBUG=_DEBUG
 
 CPP_PROJ=$(CPP_PROJ_COMMON) $(CPP_PROJ_DEBUG) $(CPP_ADD_32)
-LINK32_FLAGS=$(LINK_COMMON) /debug /machine:I386
+LINK32_FLAGS=$(LINK_COMMON) /machine:I386
 ULINK_FLAGS=-v
 
 !endif
